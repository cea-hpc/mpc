##########################################################################

#Setup vars
@PACKAGE_VAR_NAME@_NAME=@PACKAGE_NAME@
@PACKAGE_VAR_NAME@_VERSION=@PACKAGE_VERSION@
@PACKAGE_VAR_NAME@_FULL_NAME=@PACKAGE_NAME@-$(@PACKAGE_VAR_NAME@_VERSION)
@PACKAGE_VAR_NAME@_STEP_NAME=$(@PACKAGE_VAR_NAME@_FULL_NAME) for @SUBPREFIX@
@PACKAGE_VAR_NAME@_SOURCE_DIR=$(@PACKAGE_VAR_NAME@_FULL_NAME)
@PACKAGE_VAR_NAME@_BUILD_DIR=$(@PACKAGE_VAR_NAME@_SOURCE_DIR)
@PACKAGE_VAR_NAME@_BUILD_PARAMETERS=@PACKAGE_OPTIONS@ @USER_PARAMETERS@
@PACKAGE_VAR_NAME@_PATCH_FILE=$(PROJECT_PACKAGE_DIR)/@PACKAGE_NAME@/mpc-$(@PACKAGE_VAR_NAME@_FULL_NAME).patch

@PACKAGE_NAME@-gen-help: @PACKAGE_NAME@-prepare
	cd $(@PACKAGE_VAR_NAME@_BUILD_DIR) && $(STEP_WRAPPER) "Generate help $(@PACKAGE_VAR_NAME@_STEP_NAME)" ./configure --help > $(PROJECT_HELP_DIR)/$(@PACKAGE_VAR_NAME@_FULL_NAME)-help.txt

@PACKAGE_NAME@-prepare: .@PACKAGE_NAME@-prepare

.@PACKAGE_NAME@-prepare: $(PROJECT_PACKAGE_DIR)/$(@PACKAGE_VAR_NAME@_NAME)/$(@PACKAGE_VAR_NAME@_FULL_NAME).tar.*
	$(STEP_WRAPPER) "Extract $(@PACKAGE_VAR_NAME@_STEP_NAME)" $(TAR) -xf $(PROJECT_PACKAGE_DIR)/$(@PACKAGE_VAR_NAME@_NAME)/$(@PACKAGE_VAR_NAME@_FULL_NAME).tar.* && \
	if test -f $(@PACKAGE_VAR_NAME@_PATCH_FILE); \
	then \
		cd $(@PACKAGE_VAR_NAME@_SOURCE_DIR) && \
		$(STEP_WRAPPER) "Patch $(@PACKAGE_VAR_NAME@_STEP_NAME)" $(PATCH) -p1 < $(@PACKAGE_VAR_NAME@_PATCH_FILE) && \
		cd $(PROJECT_BUILD_DIR)/$(SUBPREFIX); \
	fi && \
	for dep in $$(ls -1 $(PROJECT_PACKAGE_DIR)/$(@PACKAGE_VAR_NAME@_NAME)/$(@PACKAGE_VAR_NAME@_NAME)-deps/*.tar.*); do \
		name=$$(echo $${dep} | sed -re "s/^.*\/([a-zA-Z0-9]+)-[0-9.]+\.tar.*/\1/"); \
		version=$$(echo $${dep} | sed -re "s/^.*\/[a-zA-Z0-9]+-([0-9.]+)\.tar.*/\1/"); \
		$(TAR) -xf $$dep --transform "s,$$name-$$version,$(@PACKAGE_VAR_NAME@_SOURCE_DIR)/$$name,"; \
	done; \
	touch .@PACKAGE_NAME@-prepare;
	
@PACKAGE_NAME@: .@PACKAGE_NAME@

.@PACKAGE_NAME@: .@PACKAGE_NAME@.configure .@PACKAGE_NAME@.make .@PACKAGE_NAME@.install
	test -f ".@PACKAGE_NAME@.configure" && test -f ".@PACKAGE_NAME@.make" && test -f ".@PACKAGE_NAME@.install" && touch .@PACKAGE_NAME@  

.@PACKAGE_NAME@.configure: @PACKAGE_DEPS@ .@PACKAGE_NAME@-prepare
	cd $(@PACKAGE_VAR_NAME@_BUILD_DIR) && mkdir -p build && cd build && $(STEP_WRAPPER) "Configure $(@PACKAGE_VAR_NAME@_STEP_NAME)" ../configure --prefix=$(PREFIX)/ $(@PACKAGE_VAR_NAME@_BUILD_PARAMETERS) && cd ../../ && echo "$(@PACKAGE_VAR_NAME@_BUILD_PARAMETERS)" > .@PACKAGE_NAME@.configure


.@PACKAGE_NAME@.make: @PACKAGE_DEPS@ .@PACKAGE_NAME@.configure
	export LD_LIBRARY_PATH=$(PREFIX)/libsgcc/lib:@LD_LIBRARY_PATH@ && cd $(@PACKAGE_VAR_NAME@_BUILD_DIR)/build && $(STEP_WRAPPER) "Build $(@PACKAGE_VAR_NAME@_STEP_NAME)" $(MAKE) $(MFLAGS) && cd ../../ && echo "$(MAKE) $(MFLAGS)" > .@PACKAGE_NAME@.make

.@PACKAGE_NAME@.install: @PACKAGE_DEPS@ .@PACKAGE_NAME@.configure .@PACKAGE_NAME@.make
	$(STEP_WRAPPER) "Install $(@PACKAGE_VAR_NAME@_STEP_NAME)" $(MAKE) -j1 $(MFLAGS) -C $(@PACKAGE_VAR_NAME@_BUILD_DIR)/build install && touch .@PACKAGE_NAME@.install && LD_LIBRARY_PATH=$(PREFIX)/lib:$(LD_LIBRARY_PATH) && export LD_LIBRARY_PATH

#avoid conflict with directory
.PHONY: @PACKAGE_NAME@ @PACKAGE_NAME@-gen-help
