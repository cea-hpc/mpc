#!/bin/sh
MPC_SOURCE_DIR="`dirname $0`/"
VERSION="$1"
PREFIX="$2"
ARCHIVE_TYPE="$3"
ARCHIVE_NAME="$4"
ARCHIVE_DIR="$5"
PATCH_NEEDED="$6"
PATCH_NAME="$7"
ARGUMENTS="$8"

. ${MPC_SOURCE_DIR}/../common_configure

CFLAGS="-fPIC"

#
# ARGUMENTS
#
# $0 -> configure name and path
# $1 -> Version to compile
# $2 -> Prefix of MPC installation (need to add a suffix per version)
# $3 -> Archive type (tgz, tbz or directory or download)
# $4 -> Archive name (file, directory or web address)
# $5 -> Archive dir
# $6 -> Should we apply the right patch?
# From $7 -> Additionnal arguments (for this version and in general for this module)


prepare_archive_directory

# Apply patch if needed
if test "${PATCH_NEEDED}" = "1" ; then
  CURRENT_WD=`pwd`
  echo "Applying patch ${FINAL_PATCH_NAME}..."
  cd ${ARCHIVE_DIR} || exit 1
  patch -p1 < ${FINAL_PATCH_NAME} || exit 1
  cd ${CURRENT_WD} || exit 1
fi

for arg in $ARGUMENTS
do
	case $arg in
   --mic)
     ARGUMENTS_OPENPA="${ARGUMENTS_OPENPA} --host=i686-pc-linux --target=i686-pc-linux"
     F77=ifort
     CC=icc
     AR=/usr/linux-l1om-4.7/bin/x86_64-l1om-linux-ar
     LD=/usr/linux-l1om-4.7/bin/x86_64-l1om-linux-ld
     ;;
		*)
			ARGUMENTS_OPENPA="${ARGUMENTS_OPENPA} $arg"
			;;
	esac
done

ARGUMENTS_OPENPA="$ARGUMENTS_OPENPA $(prepare_arguments)"

export CFLAGS="-mmic ${CFLAGS}"
export LDFLAGS="-mmic ${LDFLAGS}"

echo "Running: cd openpa-$VERSION"
cd openpa-$VERSION || exit 1

echo "Running: ./configure $PREFIX $ARGUMENTS_OPENPA"
./configure $PREFIX $ARGUMENTS_OPENPA || exit 1

exit 0
