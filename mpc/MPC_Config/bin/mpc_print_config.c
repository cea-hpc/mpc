/* ############################# MPC License ############################## */
/* # Wed Nov 19 15:19:19 CET 2008                                         # */
/* # Copyright or (C) or Copr. Commissariat a l'Energie Atomique          # */
/* #                                                                      # */
/* # IDDN.FR.001.230040.000.S.P.2007.000.10000                            # */
/* # This file is part of the MPC Runtime.                                # */
/* #                                                                      # */
/* # This software is governed by the CeCILL-C license under French law   # */
/* # and abiding by the rules of distribution of free software.  You can  # */
/* # use, modify and/ or redistribute the software under the terms of     # */
/* # the CeCILL-C license as circulated by CEA, CNRS and INRIA at the     # */
/* # following URL http://www.cecill.info.                                # */
/* #                                                                      # */
/* # The fact that you are presently reading this means that you have     # */
/* # had knowledge of the CeCILL-C license and that you accept its        # */
/* # terms.                                                               # */
/* #                                                                      # */
/* # Authors:                                                             # */
/* #   - VALAT Sebastien sebastien.valat@cea.fr                           # */
/* #                                                                      # */
/* ######################################################################## */

/********************  HEADERS  *********************/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "sctk_debug.h"
#include "sctk_runtime_config_mapper.h"
#include "sctk_runtime_config_walk.h"
#include "sctk_runtime_config.h"
#include "mpc_print_config_sh.h"
#include "mpc_print_config_xml.h"
#include <sctk_runtime_config_struct.h>

/*********************  CONSTS  *********************/
/**
 * Declare the global symbol containing the meta description for mapping XML to C struct.
 * The content of this table is generated by XSLT files at build time.
**/
extern const struct sctk_runtime_config_entry_meta sctk_runtime_config_db[];
/** Text for --help **/
static const char * sctk_runtime_config_help_message = "\
mpc_print_config [--text|--xml|--launcher|--help]\n\
\n\
Options :\n\
  --text     : Display the current configuration in simple text format.\n\
  --xml      : Display the current configuration in MPC config XML format.\n\
  --launcher : Display launcher options in bash variable format.\n";

/*******************  FUNCTION  *********************/
/**
 * Display the configuration for the launcher script (mpcrun) in sh format.
 * It will only display the section config.modules.launcher.
**/
void display_launcher(const struct sctk_runtime_config * config)
{
	display_tree_sh(sctk_runtime_config_db, "config_launcher","sctk_runtime_config_struct_launcher", (void*)&config->modules.launcher);
}


/*******************  FUNCTION  *********************/
/**
 * Standard display of the sturct to see the complete tee
**/
void display_all(const struct sctk_runtime_config * config)
{
	sctk_runtime_config_runtime_display();
}

/*******************  FUNCTION  *********************/
/**
 * Standard display of the sturct to see the complete tee
**/
void display_xml(const struct sctk_runtime_config * config)
{
	mpc_print_config_xml(sctk_runtime_config_db,"config","sctk_runtime_config",(void*)config);
}

/*******************  FUNCTION  *********************/
/**
 * Display help for command arguments.
**/
void display_help(void)
{
	printf(sctk_runtime_config_help_message);
}

/*******************  FUNCTION  *********************/
int main(int argc, char ** argv)
{
	//load the config
	const struct sctk_runtime_config * config = sctk_config_runtime_get();
	int res = EXIT_SUCCESS;

	//check args
	if (argc == 1)
	{
		display_all(config);
	} else if (argc == 2 && strcmp(argv[1],"--text") == 0) {
		display_all(config);
	} else if (argc == 2 && strcmp(argv[1],"--xml") == 0) {
		display_xml(config);
	} else if (argc == 2 && strcmp(argv[1],"--launcher") == 0) {
		display_launcher(config);
		printf("CONFIG_FILES_VALID=true\n");
	} else if (argc == 2 && strcmp(argv[1],"--help") == 0) {
		display_help();
	} else {
		fprintf(stderr,"Error : invalid command argument : %s\n",argv[1]);
		res = EXIT_FAILURE;
	}

	//return final status
	return res;
}

/*******************  FUNCTION  *********************/
/**
 * This is a simply way to avoid link error and avoid to init mpc just to load the config.
**/
int mpc_user_main__(void)
{
	
}
