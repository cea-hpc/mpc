
ARCH=@CONTEXT_ARCH@

CC=@CC@
CFLAGS=@CFLAGS@ -I@srcdir@/ -I@srcdir@/$(ARCH)/
LDFLAGS=@LDFLAGS@
AR=@AR@

FILES=$(wildcard @srcdir@/$(ARCH)/*.c)
OBJ=$(FILES:@srcdir@/$(ARCH)/%.c=%.o)
DEP=$(FILES:@srcdir@/$(ARCH)/%.c=%.d)

SFILES=$(wildcard @srcdir@/$(ARCH)/*.S)
SOBJ=$(SFILES:@srcdir@/$(ARCH)/%.S=%.o)
SDEP=$(SFILES:@srcdir@/$(ARCH)/%.S=%.d)

HFILES=$(wildcard @srcdir@/$(ARCH)/*.h)
DESTHFILES=$(HFILES:@srcdir@/$(ARCH)/%=../include/%)

all:../lib/libsctk_arch_microtask.so

$(OBJ):%.o:@srcdir@/$(ARCH)/%.c 
	$(CC) -c $(CFLAGS) -o $@ $?

$(SOBJ):%.o:@srcdir@/$(ARCH)/%.S 
	$(CC) -c $(CFLAGS) -o $@ $? 

# Specific rule for X86_64 with Intel file
z_Linux_asm.o: @srcdir@/X86_64/z_Linux_asm.S
	$(CC) -c $(CFLAGS) -D KMP_ARCH_STR="\"Intel(R) 64\"" -D _GNU_SOURCE -D KMP_ARCH_X86_64 -x assembler-with-cpp -o $@ $?

$(DESTHFILES):../include/%:@srcdir@/$(ARCH)/%
	cp $? $@

../lib/libsctk_arch_microtask.so:$(OBJ) $(SOBJ) $(DESTHFILES)
	@echo "Building libmicrotask for arch $(ARCH)"
	mkdir -p ../lib
	$(CC) $(LDFLAGS) -fPIC -shared $(OBJ) $(SOBJ)  -o ../lib/libsctk_arch_microtask.so
	$(AR) rcu ../lib/libsctk_arch_microtask.a  $(OBJ) $(SOBJ)
	cp @srcdir@/$(ARCH)/*.h ../include

