#!/bin/sh
############################# MPC License ##############################
# Wed Nov 19 15:19:19 CET 2008                                         #
# Copyright or (C) or Copr. Commissariat a l'Energie Atomique          #
#                                                                      #
# IDDN.FR.001.230040.000.S.P.2007.000.10000                            #
# This file is part of the MPC Runtime.                                #
#                                                                      #
# This software is governed by the CeCILL-C license under French law   #
# and abiding by the rules of distribution of free software.  You can  #
# use, modify and/ or redistribute the software under the terms of     #
# the CeCILL-C license as circulated by CEA, CNRS and INRIA at the     #
# following URL http://www.cecill.info.                                #
#                                                                      #
# The fact that you are presently reading this means that you have     #
# had knowledge of the CeCILL-C license and that you accept its        #
# terms.                                                               #
#                                                                      #
# Authors:                                                             #
#   - PERACHE Marc marc.perache@cea.fr                                 #
#                                                                      #
########################################################################
EDITOR="true"

if test "$1" = "--use-xemacs"; then 
EDITOR="xemacs"
fi

ERRORS="0"
INT_DIR="`pwd`"

FILES=""
ADD_LIST=""
UPDATE_LIST=""
EXCLUDE_FILES="MPC_Common/sctk_optim/Linux_ia64/sctk_getcontext.S MPC_Common/sctk_optim/Linux_ia64/sctk_setcontext.S MPC_Common/sctk_optim/Linux_ia64/sctk_swapcontext.c MPC_Common/sctk_optim/Linux_ia64/sctk_sysdep.h MPC_Common/sctk_optim/Linux_ia64/sctk_ucontext_i.h MPC_Compiler_Suite/mpc_opp/ast.c MPC_Compiler_Suite/mpc_opp/ast.h MPC_Compiler_Suite/mpc_opp/ast_copy.c MPC_Compiler_Suite/mpc_opp/ast_copy.h MPC_Compiler_Suite/mpc_opp/ast_free.c MPC_Compiler_Suite/mpc_opp/ast_free.h MPC_Compiler_Suite/mpc_opp/ast_print.c MPC_Compiler_Suite/mpc_opp/ast_print.h MPC_Compiler_Suite/mpc_opp/ast_show.c MPC_Compiler_Suite/mpc_opp/ast_show.h MPC_Compiler_Suite/mpc_opp/ast_vars.c MPC_Compiler_Suite/mpc_opp/ast_vars.h MPC_Compiler_Suite/mpc_opp/ast_xform.c MPC_Compiler_Suite/mpc_opp/ast_xform.h MPC_Compiler_Suite/mpc_opp/ompi.h MPC_Compiler_Suite/mpc_opp/parser.y MPC_Compiler_Suite/mpc_opp/scanner.h MPC_Compiler_Suite/mpc_opp/scanner.l MPC_Compiler_Suite/mpc_opp/str.c MPC_Compiler_Suite/mpc_opp/str.h MPC_Compiler_Suite/mpc_opp/symtab.c MPC_Compiler_Suite/mpc_opp/symtab.h MPC_Compiler_Suite/mpc_opp/x_clauses.c MPC_Compiler_Suite/mpc_opp/x_clauses.h MPC_Compiler_Suite/mpc_opp/x_for.c MPC_Compiler_Suite/mpc_opp/x_for.h MPC_Compiler_Suite/mpc_opp/x_parallel.c MPC_Compiler_Suite/mpc_opp/x_parallel.h MPC_Compiler_Suite/mpc_opp/x_sections.c MPC_Compiler_Suite/mpc_opp/x_sections.h MPC_Compiler_Suite/mpc_opp/x_shglob.c MPC_Compiler_Suite/mpc_opp/x_shglob.h MPC_Compiler_Suite/mpc_opp/x_single.c MPC_Compiler_Suite/mpc_opp/x_single.h MPC_Compiler_Suite/mpc_opp/x_thrpriv.c MPC_Compiler_Suite/mpc_opp/x_thrpriv.h MPC_Compiler_Suite/mpc_opp/x_types.c MPC_Compiler_Suite/mpc_opp/x_types.h list_of_files"


error_add(){
ERRORS="`expr $ERRORS + 1`"
}

proceed_dir(){
rm *~ > /dev/null 2>&1
for i in * ; do 
DIR="`pwd`"
if test -f $i ; then 
FILES="$FILES $DIR/$i"
fi
if test -d $i ; then 
if test "$i" != ".svn" && test "$i" != "PRIVATE_MPC_Tests" && test "$i" != "MPC_Extras" ; then 
if test "$i" != ".tmp" ; then 
cd $i
proceed_dir
cd ..
fi
fi
fi
done
}

decho(){
echo $@
}

check_license(){
RES="`grep \"$LIC_DATE\" $1 `"
if test "$RES" = "" ; then 
    echo "Old license for $i"
    error_add
    eval "$EDITOR $i"
fi
}

LIC_DATE="`cat .MPC_License`"
echo "$LIC_DATE"
proceed_dir

for i in $FILES ; do 
RES="`grep \"Copyright or (C) or Copr. Commissariat a l'Energie Atomique\" $i `"

if test "$RES" = "" ; then 
NEED="1"
for j in $EXCLUDE_FILES ; do 
    if test "$i" = "$INT_DIR/$j" ; then 
	NEED="0"	
#    else 
#	echo "$i != $INT_DIR/$j"
    fi
done

if test "$NEED" = "1" ; then  
echo "Need license for $i"
error_add
fi
eval "$EDITOR $i"
else
check_license $i
fi

FILE="`basename $i`"

INDENT="0"
if test "`basename $FILE .c`" != "$FILE" ; then 
INDENT="1"
fi
if test "`basename $FILE .h`" != "$FILE" ; then 
INDENT="1"
fi

if test "$INDENT" = "1" ; then 
    indent -nbad -bap -nbc -bbo -bl -bli2 -bls -ncdb -nce -cp1 -cs -di2 $i -o /tmp/$$_tmp.c > /dev/null 2>&1
    indent -nbad -bap -nbc -bbo -bl -bli2 -bls -ncdb -nce -cp1 -cs -di2 /tmp/$$_tmp.c > /dev/null 2>&1
    RES="`diff $i /tmp/$$_tmp.c`"
    if test "$RES" != "" ; then 
	echo "Need indentation for $i"
    fi
    rm /tmp/$$_tmp.c
fi

done


if test "$ADD_LIST" != "" ; then 
echo ""
echo "ADD $ADD_LIST"
fi


if test "$UPDATE_LIST" != "" ; then 
echo ""
echo "UPDATE $UPDATE_LIST"
fi


echo "$ERRORS errors"
exit $ERRORS
