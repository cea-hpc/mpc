#!/bin/sh

# Path to the installmpc script
SCRIPT=$(readlink -f "$0")
# Directory containing installmpc
SCRIPTPATH=$(dirname "$SCRIPT")
# Where MPC is currently being BUILT
PROJECT_BUILD_DIR=$(readlink -f $PWD)

#
# Utilities
#
#Extract parameter value and put in given variable
#Args :
# -$1 : Output variable name
# -$2 : parameter name (without --, eg. --with-XXX => 'with-XXX')
# -$3 : User value (--with-XXX=blablable)
extractParamValue()
{
	#extract in local vars
	outputvar="$1"
	name="$2"
	arg="$3"

	value=`echo "$arg" | sed -e "s/^--${name}=//g"`
	eval "${outputvar}=\"${value}\""
}

# Set a var to a value if not already set
#args :
# -$1 : output variable name
# -$2 : value triggering a set
# -$3 : value to set
enableParamIfNot()
{
	#extract in local vars
	outputvar="$1"
	output="$2"
	trigger="$3"
	value="$4"

	if [ "${output}" = "${trigger}" ]
	then
		eval "${outputvar}=\"${value}\""
	fi
}

#Extract parameter value and put in given variable
#Args :
# -$1 : Output variable name
# -$2 : parameter prefix (eg --libxml2-XXXX to add --XXX to libxml2 params)
# -$3 : User value (--libxml2-XXXX)
extractAndAddPackageOption()
{
	#extract in local vars
	outputvar="$1"
	name="$2"
	arg="$3"

	value=`echo "$arg" | sed -e "s/^--${name}//g"`
	eval "${outputvar}=\"\$${outputvar} ${value}\""
}

# Print an error message and exit
# Args:
# -$1 : Message to print
die(){
	echo "================ ERROR ================"
	echo "$1"
	echo "======================================="
	exit 1
}

#
# Output helpers
#

info()
{
	echo "INFO: $1"
}

checking()
{
	echo "## Trying to $1 ..."
}

ok()
{
	echo "## SUCCESS"
}

nok()
{
	echo "## FAIL"
}

propagate_build_env()
{
	export PATH
	export PKG_CONFIG_PATH
	export CPATH
	export CMAKE_PREFIX_PATH
	export SPACK_LOADED_HASHES
	export ACLOCAL_PATH
	export MANPATH
	export LD_LIBRARY_PATH
}

#
# Check for spack
#
HAVE_SPACK=""
check_for_spack()
{
	test -n "$HAVE_SPACK" && return

	which spack > /dev/null 2>&1

	if test "x$?" = "x0"; then
		HAVE_SPACK="yes"
	fi
}

#
# Assert spack is present
#
assert_spack()
{
	check_for_spack

	if test "x${HAVE_SPACK}" = "xno"; then
		die "Spack was not found on the system and cannot be used"
	fi
}

# Build spack package name
# Args:
# -$1 : package
# -$2 : version
#
build_package_name()
{
	if test -n "$2"; then
		echo "$1@$2"
	else
		echo "$1"
	fi
}


# Try to find a dep using spack
# Args:
# -$1 : package
# -$2 : version
#
DEP_FOUND="no"
find_dep_with_spack()
{
	check_for_spack

	DEP_FOUND="no"

	if test "x${HAVE_SPACK}" = "xno"; then
		return
	fi

	PKG_NAME="`build_package_name "$1" "$2"`"

	checking "load $PKG_NAME using spack"

	propagate_build_env

	eval `spack load --sh $PKG_NAME`

	propagate_build_env

	spack load --sh $PKG_NAME > /dev/null 2>&1

	if test "x$?" = "x0"; then
		eval `spack load --sh $PKG_NAME`
		DEP_FOUND="yes"
		ok
	else
		nok
	fi

	propagate_build_env
}

# Try to install a package using spack
#
#
install_dep_with_spack()
{
	assert_spack

	checking "install $PKG_NAME using spack"

	spack install `build_package_name "$1" "$2"`

	if test "x$?" != "x0"; then
		nok
		die "Failled to install $1@$2 using spack"
	else
		ok
	fi

	find_dep_with_spack "$1" "$2"
}


load_prefix()
{
	test -d $1/bin && PATH=$1/bin:$PATH
	test -d $1/lib && LD_LIBRARY_PATH=$1/lib:$LD_LIBRARY_PATH
	test -d $1/lib64 && LD_LIBRARY_PATH=$1/lib64:$LD_LIBRARY_PATH
	test -d $1/include && CPATH=$1/include:$CPATH
	test -d $1/lib/pkgconfig/ && PKG_CONFIG_PATH=$1/lib/pkgconfig/:$PKG_CONFIG_PATH
	test -d $1/lib64/pkgconfig/ && PKG_CONFIG_PATH=$1/lib64/pkgconfig/:$PKG_CONFIG_PATH
	test -d $1/share/man/ && MANPATH=$1/share/man/:$MANPATH

	propagate_build_env
}

# Deploy an MPC dependency using various methods (spack or not)
# Args:
# - $1: package name
# - $2: package version
# - $3: can build
# - $4: fail if not found
# - $5: candidate prefix

SPACK_LOCATE_DEPENDENCY="yes"
SPACK_INSTALL_DEPENDENCY="no"

deploy_dependency_internal()
{
	package="$1"
	version="$2"
	can_build="$3"
	can_fail="$4"
	candidate_prefix="$5"

	if test "x${candidate_prefix}" = "xdisabled"; then
		info "$package is disabled"
		return
	fi


	DEP_FOUND="no"

	if test -d "$candidate_prefix"; then
		load_prefix "$candidate_prefix"
		# Assume dep found
		DEP_FOUND="yes"
	fi



	check_for_spack

	# First use spack to locate in existing packages
	if test "x${SPACK_LOCATE_DEPENDENCY}" = "xyes"; then
		find_dep_with_spack "$package" "$version"
	fi

	# If dep is found we are done
	test "x${DEP_FOUND}" = "xyes" && return


	# We stop here if we are not alowed to build
	test "x${can_build}" = "xnobuild" && return


	if test "x${SPACK_INSTALL_DEPENDENCY}" = "xyes"; then
		install_dep_with_spack "$package" "$version"
	else
		info "Not building using spack as --enable-spack-build not passed"
	fi

	# Do a source level build only when required to
	if test "x${can_build}" != "xspackonly"; then
		echo "BUILD"
	fi


	test "x${can_fail}" = "xyes" -n "x${DEP_FOUND}" = "xno" && die "Failed to install ${package}"
}


# Deploy an MPC dependency using various methods (spack or not)
# Args:
# - $1: package name
# - $2: package version
# - $3: candidate_prefix

deploy_dependency_required()
{
	deploy_dependency_internal "$1" "$2" "yes" "build" "$3"
}

# Deploy an MPC dependency using various methods (spack or not)
# Args:
# - $1: package name
# - $2: package version
# - $3: install if not found
# - $4: candidate_prefix

deploy_dependency_optionnal()
{
	required="no"
	install="$3"
	candidate_prefix="$4"

	if test -z "$install"; then
		install="no"
	fi

	if test "x${install}" = "xyes"; then
		required="yes"
	fi

	deploy_dependency_internal "$1" "$2" "$required" "$install" "$candidate_prefix"
}


# Print usage for installmpc
showHelp()
{
cat << EOF

MPC Meta-Build script

Usage: ./installmpc [OPTION]... [VAR=VALUE]...

Defaults for the options are specified in brackets.

# Information
  --help|-h|-?                            : Display this help and exit
  --version                               : Report version number and exit

# Build & Installation
  --prefix=PREFIX                         : Install architecture-independent files in PREFIX [/usr/local]
  --disable-check-install                 : Override installation if it already exists in the prefix
  --{enable,disable}-check-deps           : Enable/Disable dependency checking
  --compiler                              : Default compiler
  --download-missing-deps                 : Download dependencies
  --mirror={1|2|3|4}                      : Choose a mirror for downloading dependencies
  clean                                   : Delete directories inside build directory
  distclean                               : Delete directories and makefiles inside build directory

# Features
  --lib-mode                              : Build MPC as a communication library
  --mpc-process-mode                      : Build MPC in process-mode (1 MPI process = 1 UNIX process)
  --{enable,disable}-mpc-ft               : Activate/Deactivate checkpoint/restart support
  --disable-color                         : Disable colors in display
  --enable-mpc-debug                      : Enable every debug levels (symbols, messages)
  --verbose=1|2|3                         : Level of verbosity
  -v|-vv|-vvv                             : Level of verbosity
  -jN                                     : Allow N jobs at once (parallel install)

# Disable sub packages
  --disable-mpc-autopriv                  : Disable privatizing compiler support
  --disable-mpc-gcc                       : Equivalent of disable-mpc-autopriv
  --disable-mpc-fortran                   : Disable fortran
  --disable-mpc-hydra                     : Disable Hydra
  --disable-romio                         : Disable ROMIO MPI-IO support
  --{enable,disable}-mpc-gdb              : Enable/Disable gdb
  --{enable,disable}-tbb                  : Enable/Disable TBB

# Specify system subpackages
  --with-autopriv=*                       : Specify autopriv prefix on the system
  --with-openpa=*                         : Specify openpa prefix on the system
  --with-hwloc=*                          : Specify hwloc prefix on the system
  --with-libxml2=*                        : Specify libxml2 prefix on the system
  --with-cuda=*                           : Specify Cuda prefix on the system
  --with-openacc=*                        : Specify OpenACC prefix on the system (NIMPL)
  --with-opencl=*                         : Specify OpenCL prefix on the system (NIMPL)
  --with-hydra=*                          : Specify Hydra prefix on the system
  --with-tbb=*                            : Specify TBB prefix on the system
  --with-{dmtcp,hbict}=*                  : Specify DMTCP/HBICT prefix on the system

# Options to transmit to subpackages
  --autopriv-*                            : Add options to autopriv configure
  --mpc-gdb-*                             : Add options to gdb configure
  --openpa-*                              : Add options to openpa configure
  --libxml2-*                             : Add options to libxml2 configure
  --hydra-*                               : Add options to Hydra configure
  --hwloc-*                               : Add options to hwloc configure
  --tbb-*                                 : Add options to TBB configure
  --{dmtcp,hbict}-*                       : Add options to DMTCP/HBICT configure
  --mpc-option=*                          : Add options to mpc framework configure

EOF
}

####################################################
#                                                  #
# MPC WRAPPER FOR BUILD                            #
#                                                  #
####################################################


MAKE_J=1

#
# Build directory check
#

# Make sure we do not install inside the source directory

if test "x${SCRIPTPATH}" = "x${PROJECT_BUILD_DIR}"; then
	die "MPC cannot be configured inside the source directory"
fi

#
# Disable all optionnal dependencies by default
#

BUILD_MPCALLOC="nobuild"

DMTCP_PREFIX="disabled"
GDB_PREFIX='disabled'
TBB_PREFIX="disabled"
SCTK_GETOPT_PREFIX='disabled'
MPC_MPIT_PREFIX='disabled'
MPL_PREFIX='disabled'

#
# Argument parsing
#

for arg in "$@"
do
	case "$arg" in
		############### BUILD SPECIFIC ###############
		--download-missing-deps|--mirror=*|clean|distclean|--with-sctk-arch=*|--sctk-arch-*|--with-mpfr=*|--mpfr-*|--with-gmp=*|--gmp-*|--with-mpc-binutils=*|--mpc-binutils-*|--disable-mpc-binutils|--with-libextls=*|--libextls-*|--with-mpc=*|--mpc-*|--enable-check-deps|--disable-check-deps|--disable-check-install|--enable-all-internals|--host=*|--target=*|--arch-library-path=*|--with-sysroot=*|--version)
			echo "INFO: $arg is deprecated"
			;;

		################# HYDRA #################
		--with-hydra=*)
			extractParamValue 'HYDRA_PREFIX' 'with-hydra' "$arg"
			;;
		--hydra-*)
			extractAndAddPackageOption 'HYDRA_BUILD_PARAMETERS' 'hydra' "$arg"
			;;
		--disable-mpc-hydra)
			HYDRA_PREFIX='disabled'
			;;
		#################### OPENPA #################
		--with-openpa=*)
			extractParamValue 'OPENPA_PREFIX' 'with-openpa' "$arg"
			;;
		--openpa-*)
			extractAndAddPackageOption 'OPENPA_BUILD_PARAMETERS' 'openpa' "$arg"
			;;
		################### MPC GDB #################
		--with-mpc-gdb=*)
			extractParamValue 'GDB_PREFIX' 'with-mpc-gdb' "$arg"
			;;
		--mpc-gdb-*)
			extractAndAddPackageOption 'GDB_BUILD_PARAMETERS' 'mpc-gdb' "$arg"
			;;
		--disable-mpc-gdb)
			GDB_PREFIX='disabled'
			;;
		--enable-mpc-gdb)
			enableParamIfNot 'GDB_PREFIX' "$GDB_PREFIX" 'disabled' 'internal'
			;;
		################### MPC GCC #################
		--with-autopriv=*)
			extractParamValue 'AUTOPRIV_PREFIX' 'with-mpc-gcc' "$arg"
			;;
		--mpc-autopriv-*)
			extractAndAddPackageOption 'AUTOPRIV_BUILD_PARAMETERS' 'mpc-autopriv' "$arg"
			;;
		--disable-mpc-gcc|--disable-autopriv)
			AUTOPRIV_PREFIX='disabled'
			;;
		################# FORTRAN GCC ###############
		--disable-mpc-fortran)
			FORTRAN_PREFIX='disabled'
			MPCFRAMEWORK_BUILD_PARAMETERS="${MPCFRAMEWORK_BUILD_PARAMETERS} --disable-fortran"
			;;
		################## LIBXML2 ##################
		--with-libxml2=*)
			extractParamValue 'LIBXML2_PREFIX' 'with-libxml2' "$arg"
			;;
		--libxml2-*)
			extractAndAddPackageOption 'LIBXML2_BUILD_PARAMETERS' 'libxml2' "$arg"
			;;
		################### HWLOC ###################
		--with-hwloc=*)
			extractParamValue 'HWLOC_PREFIX' 'with-hwloc' "$arg"
			;;
		--hwloc-*)
			extractAndAddPackageOption 'HWLOC_BUILD_PARAMETERS' 'hwloc' "$arg"
			;;
		################### CUDA ###################
		--with-cuda=*)
			extractParamValue 'CUDA_PREFIX' 'with-cuda' "$arg"
			;;
		--with-openacc=*)
			extractParamValue 'OPENACC_PREFIX' 'with-openacc' "$arg"
			;;
		--with-opencl=*)
			extractParamValue 'OPENCL_PREFIX' 'with-opencl' "$arg"
			;;
		################### TBB ###################
		--with-tbb=*)
			extractParamValue 'TBB_PREFIX' 'with-tbb' "$arg"
			;;
		--tbb-*)
			extractAndAddPackageOption 'TBB_BUILD_PARAMETERS' 'tbb' "$arg"
			;;
		--enable-mpc-tbb)
			enableParamIfNot 'TBB_PREFIX' "$TBB_PREFIX" 'disabled' 'internal'
			;;
		--disable-mpc-tbb)
			TBB_PREFIX="disabled"
			;;
		#### MPC Allocator ##########
		--enable-mpc-allocator)
			BUILD_MPCALLOC="yes"
			;;
		--disable-mpc-allocator)
			BUILD_MPCALLOC="no"
			;;
		################### HBICT ###################
		--with-hbict=*)
			extractParamValue 'HBICT_PREFIX' 'with-hbict' "$arg"
			;;
		--hbict-*)
			extractAndAddPackageOption 'HBICT_BUILD_PARAMETERS' 'hbict' "$arg"
			;;
		################### DMTCP ###################
		--with-dmtcp=*)
			extractParamValue 'DMTCP_PREFIX' 'with-dmtcp' "$arg"
			;;
		--dmtcp-*)
			extractAndAddPackageOption 'DMTCP_BUILD_PARAMETERS' 'dmtcp' "$arg"
			;;
		################### GENERIC FT ###################
		--enable-mpc-ft)
			MPCFRAMEWORK_BUILD_PARAMETERS="${MPCFRAMEWORK_BUILD_PARAMETERS} --with-dmtcp"
			enableParamIfNot 'DMTCP_PREFIX' "$DMTCP_PREFIX" 'disabled' 'internal'
			;;
		--disable-mpc-ft)
			DMTCP_PREFIX="disabled"
			;;
		################# COMPILER ##################
		--compiler=*)
			extractParamValue 'MPC_COMPILER' 'compiler' "$arg"
			COMPILER_ARG=yes
			;;
		############### MPCFRAMEWORK ################
		--mpc-option=*)
			extractAndAddPackageOption 'MPCFRAMEWORK_BUILD_PARAMETERS' 'mpc-option=' "$arg"
			;;
		--enable-color)
			MPCFRAMEWORK_BUILD_PARAMETERS="${MPCFRAMEWORK_BUILD_PARAMETERS} --enable-shell-colors"
			LIBEXTLS_BUILD_PARAMETERS="${LIBEXTLS_BUILD_PARAMETERS} --enable-color"
			;;
		--enable-mpc-debug)
			MPCFRAMEWORK_BUILD_PARAMETERS="${MPCFRAMEWORK_BUILD_PARAMETERS} --enable-debug --enable-debug-messages"
			enableParamIfNot 'GDB_PREFIX' "$GDB_PREFIX" 'disabled' 'internal'
			;;
		--with-slurm)
			MPCFRAMEWORK_BUILD_PARAMETERS="${MPCFRAMEWORK_BUILD_PARAMETERS} --with-slurm"
			;;
		--disable-MPC_MPI)
			ROMIO_PREFIX='disabled'
			MPCFRAMEWORK_BUILD_PARAMETERS="${MPCFRAMEWORK_BUILD_PARAMETERS} --disable-MPC_MPI"
			;;
		--disable-ROMIO|--disable-romio)
			ROMIO_PREFIX='disabled'
			;;
		--lib-mode)
			ROMIO_PREFIX='disabled'
			TBB_PREFIX='disabled'
			GDB_PREFIX='disabled'
			AUTOPRIV_PREFIX='disabled'
			HYDRA_PREFIX='disabled'
			SCTK_GETOPT_PREFIX='disabled'
			MPC_MPIT_PREFIX='disabled'
			MPL_PREFIX='disabled'
			MPCINSTALL_LIB_MODE='yes'
			MPCFRAMEWORK_BUILD_PARAMETERS="${MPCFRAMEWORK_BUILD_PARAMETERS} --disable-MPC_MPI --disable-MPC_Allocator --enable-lib-mode"
			#special case, when installmpc does not handle any available compiler
			#by default, GCC compiler will be used, this behavior can be altered through the --compiler= option
			COMPILER_ARG=yes
			;;
		--mpc-process-mode)
			AUTOPRIV_PREFIX='disabled'
			SCTK_GETOPT_PREFIX='disabled'
			MPCFRAMEWORK_BUILD_PARAMETERS="${MPCFRAMEWORK_BUILD_PARAMETERS} --enable-process-mode"
			#special case, when installmpc does not handle any available compiler
			#by default, GCC compiler will be used, this behavior can be altered through the --compiler= option
			COMPILER_ARG=yes
			;;

		################## COMMON ###################

		--disable-color)
			ENABLE_COLOR='false'
			;;

		-v | --verbose | --verbose=1)
			STEP_WRAPPER_VERBOSE=1
			export STEP_WRAPPER_VERBOSE
			;;
		-vv | --verbose=2)
			STEP_WRAPPER_VERBOSE=2
			export STEP_WRAPPER_VERBOSE
			;;
		-vvv | --verbose=3)
			STEP_WRAPPER_VERBOSE=3
			export STEP_WRAPPER_VERBOSE
			;;
		-j*)
			extractParamValueAlt 'MAKE_J' 'j' "$arg"
			;;
		--prefix=*)
			extractParamValue 'PREFIX' 'prefix' "$arg"
			if [ ! -d "${PREFIX}" ]; then
				mkdir -p ${PREFIX}
			fi
			;;
		--help|-h|-?)
			showHelp
			;;
		--spack|--enable-spack)
			assert_spack
			SPACK_LOCATE_DEPENDENCY="yes"
			;;
		--disable-spack)
			SPACK_LOCATE_DEPENDENCY="no"
			SPACK_INSTALL_DEPENDENCY="no"
			;;
		--spack-build|--enable-spack-build)
			assert_spack
			SPACK_LOCATE_DEPENDENCY="yes"
			SPACK_INSTALL_DEPENDENCY="yes"
			;;
		--disable-spack-build)
			SPACK_INSTALL_DEPENDENCY="no"
			;;
		*)
			echo "Invalid argument '$arg', please check your command line or get help with --help." 1>&2
			exit 1
	esac
done


# Basic dependencies
deploy_dependency_required "openpa" "" ""
deploy_dependency_required "libxml2" "" ""
deploy_dependency_required "hwloc" "1." ""

# Basic optionnal dependencies
deploy_dependency_optionnal "libunwind" "" "spackonly" ""

# Dependencies which can be deactivated
deploy_dependency_required "autopriv" "" "${AUTOPRIV_PREFIX}"
deploy_dependency_required "hydra" "" "${HYDRA_PREFIX}"
deploy_dependency_required "dmtcp" "" "${DMTCP_PREFIX}"


deploy_dependency_optionnal "mpcalloc" "" "$BUILD_MPCALLOC" "${MPCALLOC_PREFIX}"


# It is now time to configure MPC

test -z "$PREFIX" && die "Please provide a prefix where to install MPC"

propagate_build_env

$SCRIPTPATH/mpcframework/configure --prefix=${PREFIX} $MPCFRAMEWORK_BUILD_PARAMETERS


make -j $MAKE_J install